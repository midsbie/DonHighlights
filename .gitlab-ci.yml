# Reference: https://hub.docker.com/_/node/
image: node:20.11-alpine

stages:
  - security
  - lint
  - build
  - test
  - deploy

# TODO: re-enable when appropriate
# NPM audit:
#   stage: security
#   script:
#     - yarn install
#     - yarn audit

flow:
  stage: lint
  script:
    - yarn install
    - yarn run check:flow

lint:
  stage: lint
  artifacts:
    reports:
      junit: test-results/junit/*.xml
  script:
    - yarn install
    - yarn run check:lint

prettier:
  stage: lint
  script:
    - yarn install
    - yarn run check:fmt

build:
  stage: build
  artifacts:
    expire_in: 1 week
    paths:
      - dist
      - es
      - lib
  script:
    - yarn install
    - yarn run build

# Note that *all* jobs involved in testing must produce artifacts containing
# log files generated by software used by the system.
unit:
  stage: test
  artifacts:
    reports:
      junit: junit.xml
  script:
    - yarn install
    - yarn run test
